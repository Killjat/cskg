# 工业协议蜜罐系统需求分析文档

## 1. 项目背景

工业控制系统（ICS）在现代工业生产中扮演着重要角色，而工业协议（如Modbus）是ICS设备间通信的基础。随着工业物联网的发展，工业协议面临着越来越多的安全威胁。为了提高工业控制系统的安全性，需要建立一套能够监控、分析工业协议流量的蜜罐系统，用于检测和防范针对工业协议的攻击。

本项目旨在开发一套基于Go语言的工业协议蜜罐系统，能够监听多种工业协议和其他常用协议的流量，进行设备指纹识别，并提供可视化的Web界面展示实时数据。

## 2. 功能需求

### 2.1 协议支持
- 支持Modbus TCP工业协议的监控和分析
- 支持其他工业协议（如MySQL、Redis、Kafka）的监控和分析
- 支持HTTP等通用协议的监控和分析
- 支持全流量捕获和解析功能

### 2.2 蜜罐核心功能
- 数据包捕获：使用Packetbeat或类似工具监听指定端口的流量
- 设备指纹识别：自动识别访问设备的型号、制造商、操作系统等信息
- 连接记录：记录所有访问的客户端IP、端口、协议类型、时间等信息
- 会话管理：跟踪完整的会话流程，记录会话中的所有请求和响应
- 流量分析：对捕获的流量进行深度分析，识别异常行为

### 2.3 Web界面
- 实时数据展示：展示当前连接数、设备指纹数量、协议分布等统计信息
- 设备指纹列表：展示所有识别到的设备指纹，包括详细信息
- 连接记录查询：支持按时间、IP、协议等条件查询连接记录
- 会话流量展示：展示完整会话的流量详情
- 统计报表：生成各种统计报表，如流量趋势、设备类型分布等

### 2.4 网络配置
- 支持公网IP自动获取：通过curl icanhazip.com获取公网IP
- 支持内网和公网两种访问方式
- Web服务监听0.0.0.0，支持外部访问

### 2.5 系统管理
- 服务启动/停止功能：能够启动和停止蜜罐系统的各个组件
- 系统日志：生成完整的系统日志，便于故障排查和审计
- 配置管理：支持通过配置文件调整系统参数

## 3. 非功能需求

### 3.1 性能要求
- 支持高并发连接：能够处理大量并发的协议请求
- 低延迟：Web界面响应时间不超过2秒
- 高可用性：系统能够7x24小时稳定运行

### 3.2 安全性要求
- 蜜罐系统本身具有良好的安全性，不会成为攻击者的跳板
- 敏感数据加密存储：如设备指纹、连接记录等
- 访问控制：支持Web界面的身份认证和授权

### 3.3 可靠性要求
- 系统具有容错能力，单个组件故障不会导致整个系统崩溃
- 数据持久化：所有关键数据（如设备指纹、连接记录）需要持久化存储
- 系统日志完整性：确保日志不被篡改，便于审计

### 3.4 可扩展性要求
- 模块化设计：支持轻松添加新的协议支持
- 插件架构：支持通过插件扩展系统功能
- 分布式部署：支持分布式部署，监控多个网络节点

### 3.5 易用性要求
- 易于部署：提供简单的部署脚本和指南
- 易于配置：通过配置文件即可调整系统参数
- 友好的Web界面：直观、易用的Web界面，便于操作和查看数据

## 4. 技术架构

### 4.1 技术栈
- 开发语言：Go语言
- Web框架：Gin
- 数据包捕获：Packetbeat或gopacket库
- 设备指纹识别：自定义算法或开源库
- 数据存储：SQLite或其他轻量级数据库
- 配置管理：Viper
- 日志管理：自定义日志库

### 4.2 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       蜜罐系统架构                              │
├─────────┬─────────┬─────────┬─────────┬───────────────────────┤
│         │         │         │         │                       │
│ Modbus  │ MySQL   │ Redis   │ Kafka   │ 其他协议              │
│ 监控    │ 监控    │ 监控    │ 监控    │ 监控                  │
│         │         │         │         │                       │
└─────────┴─────────┴─────────┴─────────┴───────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据包捕获层                             │
│  - Packetbeat监听指定端口                                       │
│  - 全流量捕获和解析                                             │
│  - 流量保存和管理                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据处理层                               │
│  - 设备指纹识别                                                 │
│  - 连接记录管理                                                 │
│  - 会话分析                                                   │
│  - 异常检测                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                               │
│  - 设备指纹数据库                                             │
│  - 连接记录数据库                                             │
│  - 会话流量数据库                                             │
│  - 系统日志数据库                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Web应用层                                │
│  - 实时数据展示                                               │
│  - 设备指纹管理                                               │
│  - 连接记录查询                                               │
│  - 会话流量分析                                               │
│  - 统计报表生成                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 模块划分

| 模块名称         | 功能描述                                     | 技术实现                   |
|----------------|------------------------------------------|------------------------|
| 数据包捕获模块       | 监听指定端口的流量，进行全流量捕获和解析                   | gopacket库或Packetbeat工具 |
| 设备指纹识别模块      | 识别访问设备的型号、制造商、操作系统等信息                  | 自定义算法+开源库           |
| 连接记录管理模块      | 记录所有访问的客户端IP、端口、协议类型、时间等信息             | 数据库存储                 |
| 会话分析模块        | 跟踪完整的会话流程，记录会话中的所有请求和响应                 | 会话管理算法               |
| 数据存储模块        | 持久化存储设备指纹、连接记录、会话流量等数据                   | SQLite数据库             |
| Web服务模块        | 提供可视化的Web界面，展示实时数据和统计信息                   | Gin框架                 |
| 配置管理模块        | 管理系统配置，支持通过配置文件调整系统参数                   | Viper库                 |
| 日志管理模块        | 生成完整的系统日志，便于故障排查和审计                     | 自定义日志库               |

## 5. 系统流程

### 5.1 系统启动流程
1. 读取配置文件，初始化系统参数
2. 初始化日志系统
3. 初始化数据包捕获模块
4. 初始化设备指纹识别模块
5. 初始化数据存储模块
6. 启动Web服务
7. 开始监听指定端口的流量
8. 系统进入运行状态

### 5.2 流量捕获和处理流程
1. 数据包捕获模块监听指定端口的流量
2. 捕获到数据包后，进行解析和分析
3. 提取客户端IP、端口、协议类型等信息
4. 调用设备指纹识别模块，识别设备信息
5. 将连接记录和设备指纹存储到数据库
6. 跟踪会话流程，记录完整的会话流量
7. 实时更新Web界面的数据

### 5.3 Web访问流程
1. 用户通过浏览器访问蜜罐系统的Web界面
2. Web服务接收请求，进行身份认证（如果配置）
3. 查询数据库，获取实时数据和统计信息
4. 生成HTML页面，返回给用户
5. 用户可以查看设备指纹、连接记录、会话流量等信息
6. 用户可以进行查询、过滤、导出等操作

## 6. 数据模型

### 6.1 设备指纹模型

| 字段名称         | 数据类型     | 描述                     |
|----------------|----------|------------------------|
| ID             | 字符串     | 设备指纹唯一标识符              |
| ClientIP       | 字符串     | 客户端IP地址               |
| ClientPort     | 整数      | 客户端端口                 |
| ServerPort     | 整数      | 服务器端口                 |
| Protocol       | 字符串     | 协议类型（Modbus、MySQL等）     |
| FirstSeen      | 时间戳     | 首次发现时间                |
| LastSeen       | 时间戳     | 最后一次发现时间              |
| ConnectionCount| 整数      | 连接次数                  |
| DeviceInfo     | JSON对象   | 设备信息（型号、制造商、操作系统等）     |

### 6.2 连接记录模型

| 字段名称         | 数据类型     | 描述                     |
|----------------|----------|------------------------|
| ID             | 字符串     | 连接记录唯一标识符             |
| ClientIP       | 字符串     | 客户端IP地址               |
| ClientPort     | 整数      | 客户端端口                 |
| ServerPort     | 整数      | 服务器端口                 |
| Protocol       | 字符串     | 协议类型（Modbus、MySQL等）     |
| Timestamp      | 时间戳     | 连接时间                  |
| Duration       | 整数      | 连接持续时间（秒）             |
| BytesSent      | 整数      | 发送的字节数                |
| BytesReceived  | 整数      | 接收的字节数                |

### 6.3 会话流量模型

| 字段名称         | 数据类型     | 描述                     |
|----------------|----------|------------------------|
| ID             | 字符串     | 会话唯一标识符                |
| ClientIP       | 字符串     | 客户端IP地址               |
| ClientPort     | 整数      | 客户端端口                 |
| ServerPort     | 整数      | 服务器端口                 |
| Protocol       | 字符串     | 协议类型（Modbus、MySQL等）     |
| StartTime      | 时间戳     | 会话开始时间                |
| EndTime        | 时间戳     | 会话结束时间                |
| Packets        | JSON数组   | 会话中的所有数据包              |
| TotalBytes     | 整数      | 会话总流量（字节）             |

## 7. 部署要求

### 7.1 硬件要求
- CPU：至少4核
- 内存：至少8GB
- 存储空间：至少100GB（用于存储流量数据）
- 网络：稳定的网络连接，支持公网访问

### 7.2 软件要求
- 操作系统：支持Linux（CentOS、Ubuntu等）和macOS
- Go语言版本：1.21或更高
- 依赖库：Gin、Viper、gopacket等
- 数据库：SQLite或其他轻量级数据库

### 7.3 部署方式
- 本地部署：支持在本地开发环境部署和测试
- 服务器部署：支持在生产服务器上部署
- 容器化部署：支持Docker容器化部署

### 7.4 启动脚本
- 提供跨平台的启动脚本，支持macOS和CentOS
- 支持自动获取公网IP
- 支持启动和停止系统服务

## 8. 测试要求

### 8.1 功能测试
- 协议支持测试：验证系统能够正确监听和解析各种协议
- 设备指纹识别测试：验证系统能够正确识别设备信息
- Web界面测试：验证Web界面的各项功能正常
- 数据存储测试：验证数据能够正确存储和查询

### 8.2 性能测试
- 并发连接测试：测试系统在高并发情况下的性能
- 响应时间测试：测试Web界面的响应时间
- 资源占用测试：测试系统的CPU、内存占用情况

### 8.3 安全性测试
- 蜜罐系统安全性测试：验证系统本身的安全性
- 数据加密测试：验证敏感数据的加密存储
- 访问控制测试：验证Web界面的访问控制

### 8.4 可靠性测试
- 稳定性测试：测试系统7x24小时运行的稳定性
- 容错测试：测试系统在组件故障情况下的容错能力
- 恢复测试：测试系统在故障后的恢复能力

## 9. 验收标准

1. 系统能够成功启动，无错误信息
2. 系统能够正确监听指定端口的流量
3. 系统能够正确识别设备信息，生成设备指纹
4. Web界面能够正常访问，展示实时数据
5. 系统能够生成完整的系统日志
6. 系统能够支持公网和内网两种访问方式
7. 系统能够在本地开发环境和服务器环境正常运行
8. 系统符合性能、安全性、可靠性等非功能需求
9. 系统能够通过所有功能测试、性能测试、安全性测试和可靠性测试

## 10. 项目交付物

1. 蜜罐系统源代码（Go语言实现）
2. 配置文件模板
3. 部署脚本（macOS和CentOS）
4. 系统文档
   - 需求分析文档
   - 设计文档
   - 部署指南
   - 用户手册
5. 测试报告
6. 验收报告

## 11. 项目风险

1. 技术风险：
   - 数据包捕获技术的兼容性问题
   - 设备指纹识别的准确性问题
   - 高并发情况下的性能问题

2. 安全风险：
   - 蜜罐系统本身被攻击的风险
   - 敏感数据泄露的风险
   - 系统被用作跳板的风险

3. 部署风险：
   - 跨平台部署的兼容性问题
   - 依赖库版本冲突的问题
   - 系统配置复杂的问题

4. 运维风险：
   - 系统日志过大的问题
   - 流量数据存储的问题
   - 系统故障排查的问题

## 12. 风险管理措施

1. 技术风险管理：
   - 选择成熟的开源库和工具
   - 进行充分的测试和验证
   - 设计模块化架构，便于维护和扩展

2. 安全风险管理：
   - 实施严格的访问控制
   - 加密存储敏感数据
   - 定期更新系统和依赖库
   - 实施监控和告警机制

3. 部署风险管理：
   - 提供详细的部署指南
   - 提供自动化部署脚本
   - 进行充分的跨平台测试

4. 运维风险管理：
   - 实施日志轮转和归档机制
   - 实施流量数据的自动清理机制
   - 提供详细的故障排查指南
   - 实施监控和告警机制

## 13. 总结

本需求分析文档详细描述了工业协议蜜罐系统的功能需求、非功能需求、技术架构、系统流程、数据模型、部署要求、测试要求等内容。该文档将作为项目开发、测试和验收的重要依据，确保系统能够满足用户的需求，提供高质量的工业协议监控和分析功能。