# IP发现系统 - 快速开始指南

## 系统要求

- Go 1.21+
- InfluxDB 2.0+
- 网络连接（用于下载APNIC数据）

## 安装步骤

### 1. 克隆项目
```bash
git clone <repository-url>
cd cskg
```

### 2. 安装依赖
```bash
go mod tidy
```

### 3. 配置InfluxDB

#### 安装InfluxDB
```bash
# macOS
brew install influxdb

# Ubuntu/Debian
wget -qO- https://repos.influxdata.com/influxdb.key | sudo apt-key add -
echo "deb https://repos.influxdata.com/ubuntu focal stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
sudo apt update && sudo apt install influxdb2
```

#### 启动InfluxDB
```bash
# macOS
brew services start influxdb

# Linux
sudo systemctl start influxdb
```

#### 初始化InfluxDB
访问 http://localhost:8086 进行初始化设置：
- 创建组织 (Organization)
- 创建用户和密码
- 获取API Token

### 4. 配置系统

编辑 `config.yaml` 文件：
```yaml
influxdb:
  url: "http://localhost:8086"
  token: "your-influxdb-token"  # 替换为实际token
  organization: "your-org"       # 替换为实际组织名
  segments_bucket: "taiwan_ip_segments"
  alive_bucket: "taiwan_ip_alive"
```

## 使用方法

### 1. 测试系统组件
```bash
go run main.go test
```

### 2. 获取APNIC数据
```bash
go run main.go fetch
```

### 3. 扫描IP段
```bash
# 测试扫描单个CIDR段
go run main.go scan --cidr "8.8.8.0/24"

# 扫描所有IP段
go run main.go scan
```

### 4. 查看统计信息
```bash
go run main.go stats
```

## 编译可执行文件

```bash
# 编译当前平台
go build -o ip-discovery main.go

# 编译Linux版本
GOOS=linux GOARCH=amd64 go build -o ip-discovery-linux main.go

# 编译Windows版本
GOOS=windows GOARCH=amd64 go build -o ip-discovery.exe main.go
```

## 数据存储结构

### IP段信息 (taiwan_ip_segments bucket)
- measurement: `ip_segments`
- tags: `cidr`, `country`, `type`, `status`, `registry`
- fields: `start_ip`, `end_ip`, `ip_count`, `date`

### 探活结果 (taiwan_ip_alive bucket)
- measurement: `ip_alive`
- tags: `ip`, `cidr`
- fields: `is_alive`, `response_time_ms`, `packet_loss`, `error_message`

## 常见问题

### Q: InfluxDB连接失败
A: 检查InfluxDB是否正在运行，token和组织名是否正确

### Q: APNIC数据下载失败
A: 检查网络连接，或使用代理

### Q: ping权限问题
A: 在Linux上可能需要root权限或设置capabilities：
```bash
sudo setcap cap_net_raw+ep ./ip-discovery
```

### Q: 扫描速度慢
A: 调整配置文件中的并发数和超时时间：
```yaml
scanner:
  workers: 200        # 增加并发数
  ping_timeout: 500   # 减少超时时间
```

## 监控和可视化

可以使用Grafana连接InfluxDB进行数据可视化：

1. 安装Grafana
2. 添加InfluxDB数据源
3. 创建仪表板显示：
   - 存活IP数量趋势
   - IP段分布
   - 响应时间分布
   - 扫描进度

## 性能优化建议

1. **调整并发数**: 根据网络带宽和目标网络负载能力调整workers数量
2. **批量写入**: 系统已实现批量写入InfluxDB，减少网络开销
3. **缓存机制**: APNIC数据会缓存24小时，避免重复下载
4. **分时扫描**: 可以设置扫描间隔，避免对目标网络造成过大压力

## 扩展功能

系统设计为模块化，可以轻松扩展：

1. **添加新的扫描方式**: 在scanner包中添加新的扫描器
2. **支持其他国家**: 修改parser中的国家代码
3. **添加端口扫描**: 扩展ping扫描器支持端口检测
4. **集成其他数据源**: 除APNIC外，还可以集成其他IP数据源